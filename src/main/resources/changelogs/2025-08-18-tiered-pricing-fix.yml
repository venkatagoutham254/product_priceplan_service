databaseChangeLog:
  - changeSet:
      id: tiered-pricing-table-fix
      author: gowtham
      changes:
        # Drop tier-specific columns from parent if they exist
        - dropColumn:
            columnName: start_range
            tableName: rate_plan_tiered_pricing
        - dropColumn:
            columnName: end_range
            tableName: rate_plan_tiered_pricing
        - dropColumn:
            columnName: unit_price
            tableName: rate_plan_tiered_pricing
        - dropColumn:
            columnName: tier_bracket
            tableName: rate_plan_tiered_pricing


        # Create child table for tiers
        - createTable:
            tableName: rate_plan_tiered_tier
            columns:
              - column:
                  name: tier_id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: tiered_pricing_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: start_range
                  type: INTEGER
                  constraints:
                    nullable: false
              - column:
                  name: end_range
                  type: INTEGER
              - column:
                  name: unit_price
                  type: DECIMAL(12,4)
                  constraints:
                    nullable: false

        # Add foreign key from tier to parent
        - addForeignKeyConstraint:
            baseTableName: rate_plan_tiered_tier
            baseColumnNames: tiered_pricing_id
            constraintName: fk_tiered_tier_pricing
            referencedTableName: rate_plan_tiered_pricing
            referencedColumnNames: tiered_pricing_id
            onDelete: CASCADE
